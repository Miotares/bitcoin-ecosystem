<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="img-src 'self' data:;">


  <meta name="description" content="Entdecke das komplette Bitcoin-Ökosystem auf unserer interaktiven Karte. Finde Bitcoin-Services, Anbieter und Tools für Investitionen, Handel und mehr in Deutschland.">
  <meta name="keywords" content="Bitcoin Ecosystem, Bitcoin Deutschland, Bitcoin Karte, Bitcoin Services, Bitcoin Anbieter, Bitcoin Tools, Kryptowährung, Bitcoin Handel, Bitcoin Investition">
  <link rel="canonical" href="https://www.btc-eco.de/">

  <meta property="og:title" content="Bitcoin Ecosystem | Interaktive Karte des Bitcoin-Ökosystems">
  <meta property="og:description" content="Entdecke Bitcoin-Services, Anbieter und Tools auf unserer interaktiven Karte des Bitcoin-Ökosystems.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.btc-eco.de/">
  <meta property="og:image" content="https://www.bitcoin-ecosystem.de/images/bitcoin-ecosystem-og-image.jpg">
  <meta property="og:locale" content="de_DE">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Bitcoin Ecosystem | Interaktive Karte zu Bitcoin-Diensten">
  <meta name="twitter:description" content="Interaktive Karte des Bitcoin-Ökosystems mit Services, Anbietern und Tools für alle deine Bitcoin-Bedürfnisse.">
  <meta name="twitter:image" content="https://www.btc-eco.de/">

  <meta name="robots" content="index, follow">
  <meta name="language" content="German">
  <meta name="revisit-after" content="7 days">
  <meta name="author" content="Bitcoin Ecosystem Team">

  <script defer src="https://cloud.umami.is/script.js" data-website-id="4470f446-0407-4916-9dde-22e8d1566717"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="assets/logos/bitcoin.png">
  <title>Bitcoin Ecosystem | Interaktive Karte zu Bitcoin-Services, Anbietern & Tools</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      color: #333;
      overflow: hidden;
    }
    
    .container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    
    svg {
      width: 100%;
      height: 100%;
      background-color: #f8f9fa;
    }
    
    .node {
      cursor: pointer;
      pointer-events: all;
    }
    
    /* Style for anchor elements */
    svg a {
      cursor: pointer;
    }
    
    .node circle {
      fill: #fff;
      stroke: #f7931a;
      stroke-width: 2px;
      transition: all 0.3s ease;
    }
    
    .node:hover circle {
      stroke-width: 3px;
      filter: drop-shadow(0px 3px 5px rgba(0, 0, 0, 0.2));
    }
    
    .node text {
      font-size: 11px;
      font-weight: 500;
      transition: all 0.3s ease;
      pointer-events: none;
      fill: #333;
    }
    
    .category-node text {
      font-size: 14px;
      font-weight: 600;
    }
    
    .central-node text {
      font-size: 18px;
      font-weight: 700;
      fill: #fff;
    }
    
    .link {
      fill: none;
      stroke: #e0e0e0;
      stroke-width: 1.5px;
      transition: stroke 0.3s ease;
      opacity: 0.7; /* Make links slightly transparent */
    }
    
    /* Styling for highlighted links */
    .link.highlighted {
      stroke: #f7931a; /* Bitcoin orange */
      stroke-width: 2.5px;
      opacity: 1;
    }
    
    /* Styling for highlighted nodes */
    .node.highlighted circle {
      stroke-width: 3px;
      filter: drop-shadow(0px 0px 6px rgba(247, 147, 26, 0.5));
    }
    
    .controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    
    .control-button {
      background: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      font-size: 16px;
      color: #555;
    }
    
    .control-button:hover {
      background: #f9f9f9;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    .search-container {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 250px;
      z-index: 10;
    }
    
    .search-input {
      width: 100%;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 14px;
    }
    
    .legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .legend-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .tooltip {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 10px 15px;
      font-size: 14px;
      max-width: 200px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 20;
    }
    
    .node-label {
      font-size: 12px;
      overflow: visible;
      pointer-events: none;
    }
    
    .node-logo-placeholder {
      fill: rgba(255, 255, 255, 0.8);
    }
    
    /* Node color scheme */
    .depth-0 circle {
      fill: #f7931a;
      stroke: #fff;
    }
    
    .depth-1 circle {
      fill: #fff;
      stroke: #f7931a;
      stroke-width: 3px;
    }
    
    .depth-2 circle {
      fill: #f4f4f4; /* Lighter gray similar to Monero ecosystem */
      stroke: #555;  /* Darker border similar to Monero ecosystem */
      stroke-width: 1.5px;
    }
    
    .depth-3 circle {
      fill: #fff;
      stroke: #f7931a;
      stroke-width: 1.5px;
    }
    
    /* Text styles for node labels */
    .node-inner-text {
      text-anchor: middle;
      dominant-baseline: middle;
      pointer-events: none;
    }
    
    /* Text styles for external labels (below nodes) */
    .node-external-text {
      text-anchor: middle;
      pointer-events: none;
      font-size: 10px;
      fill: #333;
    }
    
    .depth-0 .node-inner-text {
      fill: #fff;
      font-weight: bold;
      font-size: 18px;
    }
    
    .depth-1 .node-inner-text {
      fill: #333;
      font-weight: 600;
      font-size: 14px;
    }
    
    .depth-2 .node-external-text {
      font-weight: 500;
      font-size: 11px;
    }
    
    .depth-3 .node-external-text {
      font-weight: normal;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="search-container">
      <input type="text" class="search-input" placeholder="Search the Bitcoin ecosystem...">
      <select class="filter-select" aria-label="Region filtern">
        <option value="">Alle Regionen</option>
        <option value="International">International</option>
        <option value="Europa">Europa</option>
      </select>
    </div>
    
    <div class="controls">
      <button class="control-button" id="zoom-in">+</button>
      <button class="control-button" id="zoom-out">−</button>
      <button class="control-button" id="reset">⟳</button>
    </div>
    
    
    
    <div class="tooltip"></div>
    
    <svg id="bitcoin-ecosystem"></svg>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script>
// Dynamisches Laden der Services aus JSON und Rendering mit D3
(async function() {
  const response = await fetch('assets/services.json');
  const data = await response.json();

  const svg = d3.select("#bitcoin-ecosystem");
  const width = window.innerWidth;
  const height = window.innerHeight;
  const g = svg.append("g");
  const defs = svg.append("defs");

  // Zusatzstyles
  const style = document.createElement('style');
  style.textContent = `
    /* UI */
    /* Regionen-Filter vorübergehend ausgeblendet - zum Einblenden einfach "display: none;" entfernen */
    .filter-select { 
      display: none; /* TODO: Entfernen zum Wieder-Einblenden */
      margin-top: 10px; width: 100%; padding: 10px 36px 10px 12px; 
      border: 1px solid #e6e6e6; border-radius: 10px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.06); font-size: 14px; background: #fff;
      appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
      background-repeat: no-repeat; background-position: right 12px center; background-size: 16px;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    .filter-select:focus { outline: none; border-color: #f5b26a; box-shadow: 0 4px 14px rgba(247,147,26,0.18); }

    .detail-popup { position: fixed; right: 20px; top: 80px; width: 340px; max-height: calc(100vh - 120px); overflow: auto; 
      background: #fff; border-radius: 12px; border: 1px solid #eee; 
      box-shadow: 0 14px 30px rgba(0,0,0,0.14); padding: 16px 16px 14px; z-index: 30; }
    .detail-popup .header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .detail-popup .header img { width: 22px; height: 22px; border-radius: 50%; flex: 0 0 22px; }
    .detail-popup h3 { font-size: 16px; margin-bottom: 0; line-height: 1.2; }
    .detail-popup p { font-size: 13px; color: #555; margin-bottom: 8px; line-height: 1.45; }
    .detail-popup .meta { font-size: 12px; color: #777; margin-bottom: 12px; }
    .detail-popup .actions { display: flex; justify-content: flex-end; gap: 8px; }
    .detail-popup .btn { padding: 6px 10px; border-radius: 9px; border: 1px solid #ececec; background: #f7931a; color: #fff; font-weight: 600; font-size: 12.5px; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .detail-popup .btn:hover { filter: brightness(0.98); }
    .detail-popup .btn .icon { font-size: 10px; opacity: 0.9; line-height: 1; }

    /* Mobile-only Anpassungen */
    @media (max-width: 640px) {
      .search-container { left: 12px; top: 12px; width: calc(100% - 24px); }
      .search-input { height: 40px; font-size: 15px; }
      .filter-select { margin-top: 8px; height: 40px; font-size: 14px; }
      .controls { display: none; }

      /* Popup als Bottom-Sheet */
      .detail-popup {
        right: 0; left: 0; bottom: 0; top: auto; width: 100%; max-height: 52vh;
        border-radius: 12px 12px 0 0; border: 1px solid #eee; padding: 14px 14px 18px;
      }
      .detail-popup .header img { width: 20px; height: 20px; }
      .detail-popup h3 { font-size: 15px; }
      .detail-popup p { font-size: 13px; }
      .detail-popup .btn { font-size: 12.5px; padding: 6px 10px; }
      .detail-popup .btn .icon { font-size: 9px; }
    }

    /* Node Shapes */
    .depth-0 circle { fill: #f7931a; stroke: #fff; stroke-width: 2px; }
    .depth-1 rect, .depth-2 rect { fill: #fff; stroke: #f7931a; stroke-width: 2px; rx: 4px; ry: 4px; }
    .depth-1 rect { stroke-width: 3px; }
    .depth-2 rect { fill: #f4f4f4; stroke: #555; }
    .depth-3 circle { fill: #fff; stroke: #f7931a; stroke-width: 1.5px; }
    .node-inner-text { text-anchor: middle; dominant-baseline: middle; pointer-events: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .depth-0 .node-inner-text { fill: #fff; font-weight: bold; font-size: 18px; }
    .depth-1 .node-inner-text, .depth-2 .node-inner-text { fill: #333; font-weight: 600; font-size: 12px; }
    .depth-3 .node-inner-text { fill: #333; font-weight: 500; font-size: 11px; }
    .node-label { text-anchor: middle; font-size: 10px; fill: #333; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; pointer-events: none; }
    .node.highlighted circle, .node.highlighted rect { filter: drop-shadow(0px 0px 6px rgba(247, 147, 26, 0.5)); }
    .link.highlighted { stroke: #f7931a !important; stroke-width: 2.5px !important; opacity: 1 !important; }
  `;
  document.head.appendChild(style);

  // Zoom
  const zoom = d3.zoom().scaleExtent([0.1, 3]).on("zoom", (event) => { g.attr("transform", event.transform); });
  svg.call(zoom);

  // Simulation
  const simulation = d3.forceSimulation()
    .force("link", d3.forceLink().id(d => d.id).distance(d => d.source.depth === 0 ? 280 : d.source.depth === 1 ? 180 : d.source.depth === 2 ? 140 : 120))
    .force("charge", d3.forceManyBody().strength(d => d.depth === 0 ? -7000 : d.depth === 1 ? -4000 : d.depth === 2 ? -2000 : -1000))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collide", d3.forceCollide(d => d.depth === 0 ? 150 : d.depth === 1 ? 120 : d.depth === 2 ? 90 : 60).strength(1))
    .force("x", d3.forceX(width / 2).strength(0.005))
    .force("y", d3.forceY(height / 2).strength(0.005))
    .alphaDecay(0.02);

  simulation.force("cluster", forceCluster());
  function forceCluster() {
    const strength = 0.15; let nodes;
    function force(alpha) {
      const nodesByParent = {};
      nodes.forEach(node => { if (node.parent) { const pid = node.parent.id; (nodesByParent[pid] ||= []).push(node); }});
      Object.entries(nodesByParent).forEach(([pid, children]) => {
        const parent = nodes.find(n => n.id === pid); if (!parent) return; const k = alpha * strength;
        let cx = 0, cy = 0; children.forEach(c => { cx += c.x; cy += c.y; }); cx/=children.length; cy/=children.length;
        children.forEach(c => { c.vx += (parent.x - c.x) * k; c.vy += (parent.y - c.y) * k; c.vx += (cx - c.x) * k * 0.3; c.vy += (cy - c.y) * k * 0.3; });
      });
    }
    force.initialize = function(_nodes){ nodes = _nodes; };
    return force;
  }

  // Fallback-Logo für Genesis, falls nicht in JSON gesetzt
  if (!data.image) { data.image = 'assets/logos/bitcoin.png'; }
  // Index der kanonischen Leaf-Services aufbauen (für Aliase via ref)
  const serviceIndex = new Map();
  (function buildIndex(node){
    if (!node || !node.children) return;
    for (const child of node.children){
      if (child.children && child.children.length){
        buildIndex(child);
      } else if (child.id) {
        serviceIndex.set(child.id, {
          id: child.id,
          name: child.name || '',
          link: child.link || '',
          image: child.image || '',
          description: child.description || '',
          region: child.region || ''
        });
      }
    }
  })(data);

  const root = d3.hierarchy(data);
  const nodes = flatten(root);
  const links = root.links();

  function flatten(root) {
    const list = [];
    function walk(node, depth = 0) {
      if (node.children) node.children.forEach(child => walk(child, depth + 1));
      if (node.data && node.data.id) {
        // Alias-Auflösung: wenn ref gesetzt ist, Daten aus Index übernehmen
        const refId = node.data.ref;
        const aliased = refId ? serviceIndex.get(refId) : null;
        node.id = node.data.id; node.depth = depth;
        node.name = (node.data.name ?? aliased?.name) || "";
        node.link = (node.data.link ?? aliased?.link) || "";
        node.image = (node.data.image ?? aliased?.image) || "";
        node.description = (node.data.description ?? aliased?.description) || "";
        node.region = (node.data.region ?? aliased?.region) || "";
        list.push(node);
      }
    }
    walk(root); return list;
  }

  // Größen für Rechtecke berechnen (Depth 1/2)
  nodes.forEach(d => { if (d.depth === 1 || d.depth === 2) { const textLength = d.name.length; const charWidth = 7; const padding = 24; const minWidth = 60; d.rectWidth = Math.max(minWidth, textLength * charWidth + padding); d.rectHeight = 44; }});

  const link = g.selectAll(".link").data(links).enter().append("line").attr("class", d => `link link-${d.source.id} link-${d.target.id}`).style("stroke", "#e0e0e0").style("stroke-width", "1.5px").style("opacity", 0.7);

  const node = g.selectAll(".node").data(nodes).enter().append("g").attr("class", d => `node depth-${d.depth}`).attr("id", d => `node-${d.id}`).style("cursor", d => (!d.children || d.children.length === 0) ? "pointer" : "default")
    .on("click", function(event, d){
      // Nur bei echten Services (Leaf-Knoten) Popup öffnen
      if (d.children && d.children.length > 0) return;
      event.stopPropagation();
      openPopup(event, d);
    })
    .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended));

  node.each(function(d){ const s = d3.select(this);
    if (d.depth === 0 || d.depth === 3) { const r = d.depth === 0 ? 50 : 30; s.append("circle").attr("r", r).attr("class", "node-shape"); }
    else { s.append("rect").attr("width", d.rectWidth).attr("height", d.rectHeight).attr("x", -d.rectWidth/2).attr("y", -d.rectHeight/2).attr("class", "node-shape"); }
  });

  // Inhalte (Logo aus JSON oder Text)
  node.each(function(d){ const s = d3.select(this);
    if (d.image) {
      const clipId = `clip-${d.id}`;
      if (d.depth === 0 || d.depth === 3) { const r = d.depth === 0 ? 50 : 30; defs.append("clipPath").attr("id", clipId).append("circle").attr("r", r);
        s.append("image").attr("xlink:href", d.image).attr("x", -r).attr("y", -r).attr("width", r*2).attr("height", r*2).attr("clip-path", `url(#${clipId})`).on("error", function(){ d3.select(this).remove(); addNodeText(s, d); });
      } else { defs.append("clipPath").attr("id", clipId).append("rect").attr("width", d.rectWidth).attr("height", d.rectHeight).attr("x", -d.rectWidth/2).attr("y", -d.rectHeight/2).attr("rx", 4).attr("ry", 4);
        s.append("image").attr("xlink:href", d.image).attr("x", -d.rectWidth/2).attr("y", -d.rectHeight/2).attr("width", d.rectWidth).attr("height", d.rectHeight).attr("clip-path", `url(#${clipId})`).on("error", function(){ d3.select(this).remove(); addNodeText(s, d); });
      }
    } else { addNodeText(s, d); }
    if (d.depth === 3) { s.append("text").attr("class", "node-label").attr("x", 0).attr("y", 42).attr("text-anchor", "middle").text(d.name); }
  });

  function addNodeText(sel, d){ if (d.depth !== 3) sel.append("text").attr("class", "node-inner-text").text(d.name); }

  // Hover Highlight
  node.on("mouseover", function(event, d){ const current = d3.select(this); const id = d.id; current.classed("highlighted", true); link.classed("highlighted", function(l){ if (l.source.id === id || l.target.id === id){ const connectedId = l.source.id === id ? l.target.id : l.source.id; g.selectAll('.node').filter(n => n.id === connectedId).classed("highlighted", true); return true; } return false; }); })
      .on("mouseout", function(){ g.selectAll(".highlighted").classed("highlighted", false); });

  // Layout initialisieren (erst Simulation mit Nodes verbinden, dann warmup)
  simulation.nodes(nodes).on("tick", ticked);
  simulation.force("link").links(links);
  optimizeNodeDistribution();
  warmupSimulation();
  // Nach dem Warmup direkt beruhigen, damit Startzustand stabil ist
  simulation.alpha(0);
  setTimeout(resetZoom, 2000);
  addEntranceAnimations();

  function optimizeNodeDistribution(){ const rootNode = nodes.find(n => n.depth === 0); if (rootNode){ rootNode.x = width/2; rootNode.y = height/2; rootNode.fx = width/2; rootNode.fy = height/2; }
    const childCounts = {}; nodes.forEach(n => { if (n.depth === 1){ childCounts[n.id] = nodes.filter(x => x.parent && x.parent.id === n.id).length; } });
    const level1 = nodes.filter(n => n.depth === 1).sort((a,b)=>childCounts[b.id]-childCounts[a.id]);
    if (level1.length){ const quads = [[],[],[],[]]; level1.forEach((n,i)=>{ quads[i%4].push(n); }); quads.forEach((arr,qi)=>{ if (!arr.length) return; const a0 = qi*Math.PI/2; const a1 = (qi+1)*Math.PI/2; const step = (a1-a0)/(arr.length+1); arr.forEach((n,i)=>{ const a=a0+step*(i+1); const r=300; n.x=width/2+r*Math.cos(a); n.y=height/2+r*Math.sin(a); }); }); }
    nodes.filter(n=>n.depth===2).forEach(n=>{ if(!n.parent) return; const sib = nodes.filter(x=>x.depth===2 && x.parent && x.parent.id===n.parent.id); const dx=n.parent.x-width/2, dy=n.parent.y-height/2; const pa=Math.atan2(dy,dx); const arc=Math.PI*0.5; const step=arc/(sib.length+1); const start=pa-arc/2; const idx=sib.findIndex(s=>s.id===n.id); const a=start+step*(idx+1); const r=140; n.x=n.parent.x+r*Math.cos(a); n.y=n.parent.y+r*Math.sin(a); });
    nodes.filter(n=>n.depth===3).forEach(n=>{ if(!n.parent) return; const sib = nodes.filter(x=>x.depth===3 && x.parent && x.parent.id===n.parent.id); const dx=n.parent.x-width/2, dy=n.parent.y-height/2; const pa=Math.atan2(dy,dx); const arc=Math.PI*0.3; const step=arc/(sib.length+1); const start=pa-arc/2; const idx=sib.findIndex(s=>s.id===n.id); const a=start+step*(idx+1); const r=100; n.x=n.parent.x+r*Math.cos(a); n.y=n.parent.y+r*Math.sin(a); }); }

  function warmupSimulation(){ const rootNode = nodes.find(n => n.depth === 0); if (rootNode){ rootNode.fx = width/2; rootNode.fy = height/2; } optimizeNodeDistribution(); simulation.alpha(1); for(let i=0;i<100;i++){ simulation.tick(); } [0.5,0.3,0.1].forEach(a=>{ simulation.alpha(a); for(let i=0;i<50;i++){ simulation.tick(); } }); ticked(); }
  function addEntranceAnimations(){ link.style("opacity",0).transition().delay((d,i)=>300+i*5).duration(800).style("opacity",0.7); node.style("opacity",0).attr("transform", d=>`translate(${width/2},${height/2}) scale(0.1)`).transition().delay(d=>d.depth*200).duration(1000).style("opacity",1).attrTween("transform", function(d){ return t=>{ const x=width/2+(d.x-width/2)*t; const y=height/2+(d.y-height/2)*t; const s=0.1+t*0.9; return `translate(${x},${y}) scale(${s})`; }; }); }
  function resetZoom(){ const rootNode = nodes.find(n=>n.depth===0); let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity; nodes.forEach(n=>{ minX=Math.min(minX,n.x); maxX=Math.max(maxX,n.x); minY=Math.min(minY,n.y); maxY=Math.max(maxY,n.y); }); const pad=50; minX-=pad; maxX+=pad; minY-=pad; maxY+=pad; const gw=maxX-minX, gh=maxY-minY; const s=Math.min(width/gw, height/gh, 1)*0.9; svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity.translate(width/2,height/2).scale(s).translate(-rootNode.x,-rootNode.y)); }
  function ticked(){ const rootNode = nodes.find(n=>n.depth===0); if(rootNode){ rootNode.x=width/2; rootNode.y=height/2; } link.attr("x1", d=>d.source.x).attr("y1", d=>d.source.y).attr("x2", d=>d.target.x).attr("y2", d=>d.target.y); g.selectAll('.node').attr("transform", d=>`translate(${d.x},${d.y})`); }
  function dragstarted(event,d){ if(d.depth===0) return; if(!event.active) simulation.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
  function dragged(event,d){ if(d.depth===0) return; d.fx=event.x; d.fy=event.y; }
  function dragended(event,d){ if(d.depth===0) return; if(!event.active) simulation.alphaTarget(0); d.fx=null; d.fy=null; }

  // Zoom-Buttons
  function initZoomControls(){
    document.getElementById("zoom-in").replaceWith(document.getElementById("zoom-in").cloneNode(true));
    document.getElementById("zoom-out").replaceWith(document.getElementById("zoom-out").cloneNode(true));
    document.getElementById("reset").replaceWith(document.getElementById("reset").cloneNode(true));
    document.getElementById("zoom-in").addEventListener("click",()=>{ svg.transition().duration(300).call(zoom.scaleBy,1.3); });
    document.getElementById("zoom-out").addEventListener("click",()=>{ svg.transition().duration(300).call(zoom.scaleBy,0.7); });
    document.getElementById("reset").addEventListener("click", resetZoom);
  }
  initZoomControls();

  // Suche + Regionsfilter kombinieren
  const searchInput = document.querySelector('.search-input');
  const regionSelect = document.querySelector('.filter-select');
  searchInput.addEventListener('input', applyFilters);
  regionSelect.addEventListener('change', applyFilters);

  function applyFilters(){
    const term = searchInput.value.toLowerCase();
    const region = regionSelect.value;
    const matched = new Set();
    nodes.forEach(n => {
      const isLeaf = !n.children || n.children.length === 0;
      const nameMatch = n.name.toLowerCase().includes(term);
      const regionMatch = !region || (n.region || '') === region || (!isLeaf && term !== '');
      if ((term === '' && region === '' && isLeaf) || (nameMatch || regionMatch)) {
        if (isLeaf && (region === '' || (n.region || '') === region) && (term === '' || nameMatch)) {
          matched.add(n);
          let a = n.parent; while(a){ matched.add(a); a = a.parent; }
        }
      }
    });
    if (term === '' && region === '') { node.style('opacity',1); link.style('opacity',1); return; }
    node.style('opacity', d => matched.has(d) ? 1 : 0.15);
    link.style('opacity', d => matched.has(d.source) && matched.has(d.target) ? 1 : 0.05);
  }

  // Popup bei Klick: fixiertes Panel rechts, schließt bei Außenklick
  let popupEl = null;
  function openPopup(event, d){
    if (!popupEl) {
      popupEl = document.createElement('div');
      popupEl.className = 'detail-popup';
      document.body.appendChild(popupEl);
      popupEl.addEventListener('click', (e)=> e.stopPropagation());
      document.addEventListener('click', onDocClick);
    }
    popupEl.innerHTML = `
      <div class="header">
        ${d.image ? `<img src="${d.image}" alt="${d.name}">` : ''}
        <h3>${d.name}</h3>
      </div>
      ${d.description ? `<p>${d.description}</p>` : ''}
      <div class="meta">${d.region ? `Region: ${d.region}` : ''}</div>
      <div class="actions">${d.link ? `<a class="btn" href="${d.link}" target="_blank" rel="noopener">Zum Service <span class="icon" aria-hidden="true">↗</span></a>` : ''}</div>
    `;
  }
  function closePopup(){ if(popupEl){ popupEl.remove(); popupEl = null; document.removeEventListener('click', onDocClick); }}
  function onDocClick(){ closePopup(); }

  // Resize-Handling
  window.addEventListener('resize', ()=>{ const nw = window.innerWidth; const nh = window.innerHeight; const rootNode = nodes.find(n=>n.depth===0); if(rootNode){ rootNode.fx = nw/2; rootNode.fy = nh/2; } simulation.force('center', d3.forceCenter(nw/2, nh/2)).alpha(0.3).restart(); initZoomControls(); });

  // Footer
  const footer = document.createElement('div'); footer.style.cssText = `position:absolute; bottom:20px; right:20px; background:white; padding:8px 15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); font-size:12px; z-index:10; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;`; footer.innerHTML = 'Made with ❤️ by <a href="https://twitter.com/miotares" target="_blank" style="color: #1DA1F2; text-decoration: none; font-weight: 600;">@miotares</a> · <a href="https://miotares.com" target="_blank" style="color: #1DA1F2; text-decoration: none; font-weight: 600;">More projects</a>'; document.querySelector('.container').appendChild(footer);
})();
  </script>
</body>
</html>